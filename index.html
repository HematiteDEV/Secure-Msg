<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Offline Messenger</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#121212">
    <style>
        :root {
            --bg-color: #121212;
            --surface-color: #1e1e1e;
            --primary-color: #bb86fc;
            --text-color: #e0e0e0;
            --border-color: #333;
            --error-color: #cf6679;
            --success-color: #03dac6;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, sans-serif;
            margin: 0; padding: 15px;
            display: flex; flex-direction: column; align-items: center;
        }
        .container {
            width: 100%; max-width: 500px;
            background-color: var(--surface-color);
            padding: 24px; border-radius: 16px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.6); box-sizing: border-box;
        }
        .app-header {
            text-align: center; font-size: 1.55rem; font-weight: bold;
            margin-bottom: 20px; display: flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .header-input {
            width: 100%; background: transparent; border: none;
            border-bottom: 2px solid var(--border-color); color: var(--text-color);
            font-size: 1.35rem; font-weight: bold; text-align: center;
            margin-bottom: 20px; outline: none; padding-bottom: 8px;
        }
        .header-input:focus { border-bottom-color: var(--primary-color); }
        textarea {
            width: 100%; height: 160px; background-color: #2c2c2c;
            color: var(--text-color); border: 1px solid var(--border-color);
            border-radius: 12px; padding: 14px; font-size: 1.05rem;
            resize: vertical; box-sizing: border-box; outline: none; line-height: 1.6;
        }
        textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(187,134,252,0.2);
        }
        .controls { display: flex; flex-wrap: wrap; gap: 10px; margin: 12px 0; }
        .btn {
            flex: 1; padding: 12px 16px; border-radius: 12px; cursor: pointer;
            font-size: 0.95rem; transition: all 0.2s; border: 1px solid var(--border-color);
            background: #333; color: var(--text-color); font-weight: 500;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary-color); color: #000; font-weight: bold; border: none; }
        .btn-danger { background: transparent; color: var(--error-color); border: 1px solid var(--error-color); }
        .password-wrapper { position: relative; width: 100%; }
        .toggle-btn {
            position: absolute; right: 14px; top: 50%; transform: translateY(-50%);
            background: none; border: none; font-size: 1.35rem; color: #aaa; cursor: pointer; padding: 0 4px;
        }
        .stats { font-size: 0.85rem; color: #aaa; margin: 8px 0; display: flex; justify-content: space-between; }
        #statusMsg { font-size: 0.95rem; margin-top: 15px; text-align: center; min-height: 24px; font-weight: bold; }
        .about { text-align: center; margin-top: 25px; font-size: 0.85rem; color: #666; line-height: 1.6; }
        .about strong { color: var(--primary-color); letter-spacing: 1px; }
        input[type="password"], input[type="text"].pass-text, select {
            padding: 14px; border-radius: 12px; border: 1px solid var(--border-color);
            background-color: #2c2c2c; color: var(--text-color); outline: none; width: 100%;
            box-sizing: border-box; font-size: 1rem;
        }
        input:focus, select:focus { border-color: var(--primary-color); }
    </style>
</head>
<body>

<div class="container">
    <div class="app-header">üîê Secure Messenger</div>

    <input type="text" id="fileName" class="header-input" value="Untitled Document" placeholder="Document Name">

    <div class="controls">
        <button class="btn" onclick="setTextDir('ltr')">EN ‚û°Ô∏è</button>
        <button class="btn" onclick="setTextDir('rtl')">‚¨ÖÔ∏è FA</button>
    </div>

    <textarea id="messageBox" placeholder="Type your message or paste encrypted text here..."></textarea>
    
    <div class="stats">
        <span id="statsDisplay">Characters: 0 | Words: 0</span>
        <span id="lengthDisplay" style="color: var(--primary-color);"></span>
    </div>

    <div class="controls" style="margin-top: 15px;">
        <div class="password-wrapper">
            <input type="password" id="secretKey" class="pass-text" placeholder="Enter Secret Password">
            <button type="button" class="toggle-btn" id="togglePass" onclick="togglePassword()">üëÅÔ∏è</button>
        </div>
    </div>

    <div class="controls" style="margin-top: 5px;">
        <select id="expirationSelect">
            <option value="0">‚è≥ No Expiration</option>
            <option value="1">‚è≥ Expires in 1 Hour</option>
            <option value="24">‚è≥ Expires in 24 Hours</option>
            <option value="168">‚è≥ Expires in 7 Days</option>
        </select>
    </div>

    <div class="controls">
        <button class="btn btn-primary" onclick="encryptMessage()">üîí Encrypt</button>
        <button class="btn btn-primary" onclick="decryptMessage()">üîì Decrypt</button>
    </div>

    <div class="controls">
        <button class="btn" onclick="copyToClipboard()">üìã Copy</button>
        <button class="btn" onclick="pasteAndDecrypt()">üìù Paste</button>
    </div>
    <div class="controls">
        <button class="btn" onclick="shareMessage()">üì§ Share</button>
        <button class="btn" onclick="downloadFile()">üì• Save File</button>
    </div>

    <div class="controls" style="margin-top: 15px;">
        <button class="btn" onclick="document.getElementById('fileUpload').click()">üìÇ Upload File</button>
        <button class="btn btn-danger" onclick="clearAllFields()">üóë Clear</button>
    </div>

    <input type="file" id="fileUpload" accept=".enc,.txt" style="display:none">

    <div id="statusMsg"></div>
    
    <div class="about">
        Fully offline ‚Ä¢ End-to-end encrypted PWA<br>
        Developed by <strong>HematiteDEV</strong>
    </div>
</div>

<script>
    const messageBox = document.getElementById('messageBox');
    const fileName = document.getElementById('fileName');
    const statsDisplay = document.getElementById('statsDisplay');
    const lengthDisplay = document.getElementById('lengthDisplay');
    const secretKeyInput = document.getElementById('secretKey');
    const expirationSelect = document.getElementById('expirationSelect');
    const statusMsg = document.getElementById('statusMsg');
    const togglePassBtn = document.getElementById('togglePass');

    let inactivityTimer;
    const TIME_LIMIT = 60000;

    function clearSensitiveData() {
        if (messageBox.value || secretKeyInput.value) {
            messageBox.value = ''; secretKeyInput.value = ''; localStorage.removeItem('savedMessage');
            updateStats(); showStatus('üîí Data auto-cleared (1 min inactivity)', 'var(--error-color)');
        }
    }

    function resetTimer() { clearTimeout(inactivityTimer); inactivityTimer = setTimeout(clearSensitiveData, TIME_LIMIT); }
    ['touchstart', 'click', 'keypress', 'mousemove', 'scroll'].forEach(evt => document.addEventListener(evt, resetTimer));

    function clearAllFields() {
        messageBox.value = ''; secretKeyInput.value = ''; localStorage.removeItem('savedMessage');
        updateStats(); showStatus('üóë All fields cleared', 'var(--success-color)'); resetTimer();
    }

    window.onload = () => {
        localStorage.removeItem('savedMessage'); messageBox.value = ''; secretKeyInput.value = '';
        if (localStorage.getItem('savedFileName')) fileName.value = localStorage.getItem('savedFileName');
        if (localStorage.getItem('savedDir')) messageBox.dir = localStorage.getItem('savedDir');
        updateStats(); resetTimer();
    };

    messageBox.addEventListener('input', () => { localStorage.setItem('savedMessage', messageBox.value); updateStats(); });
    fileName.addEventListener('input', () => localStorage.setItem('savedFileName', fileName.value));

    function updateStats() {
        const text = messageBox.value;
        statsDisplay.textContent = `Characters: ${text.length} | Words: ${text.trim() === '' ? 0 : text.trim().split(/\s+/).length}`;
        lengthDisplay.textContent = (text.length > 60 && !text.includes(' ')) ? `Length: ${text.length}` : '';
    }

    function setTextDir(dir) { messageBox.dir = dir; localStorage.setItem('savedDir', dir); }

    function showStatus(msg, color = 'var(--primary-color)') {
        statusMsg.textContent = msg; statusMsg.style.color = color; setTimeout(() => statusMsg.textContent = '', 4500);
    }

    function togglePassword() {
        if (secretKeyInput.type === 'password') {
            secretKeyInput.type = 'text'; togglePassBtn.textContent = 'üôà';
        } else {
            secretKeyInput.type = 'password'; togglePassBtn.textContent = 'üëÅÔ∏è';
        }
    }

    async function copyToClipboard() {
        try {
            if (navigator.clipboard && window.isSecureContext) {
                await navigator.clipboard.writeText(messageBox.value);
                showStatus('‚úÖ Copied to clipboard', 'var(--success-color)');
            } else {
                messageBox.select(); document.execCommand('copy'); window.getSelection().removeAllRanges();
                showStatus('‚úÖ Copied (Legacy Mode)', 'var(--success-color)');
            }
        } catch (err) { showStatus('Copy failed. Please copy manually.', 'var(--error-color)'); }
    }

    async function pasteAndDecrypt() {
        try {
            if (navigator.clipboard && navigator.clipboard.readText) {
                const text = await navigator.clipboard.readText();
                if(text) { messageBox.value = text; decryptMessage(); }
                else showStatus('Clipboard is empty.', 'var(--error-color)');
            } else showStatus('Auto-paste blocked. Paste manually.', 'var(--error-color)');
        } catch (err) { showStatus('Auto-paste blocked. Paste manually.', 'var(--error-color)'); }
    }

    async function shareMessage() {
        if (!messageBox.value) return showStatus('Nothing to share!', 'var(--error-color)');
        if (navigator.share) {
            try { await navigator.share({ title: fileName.value || 'Encrypted Message', text: messageBox.value }); showStatus('üì§ Shared successfully', 'var(--success-color)'); }
            catch (e) { /* ⁄©ÿßÿ±ÿ®ÿ± ÿ®Ÿá ÿßÿ¥ÿ™ÿ±ÿß⁄© ⁄Øÿ∞ÿßÿ±€å ÿ±ÿß ⁄©ŸÜÿ≥ŸÑ ⁄©ÿ±ÿØŸá */ }
        } else showStatus('Share not supported in this browser', 'var(--error-color)');
    }

    function downloadFile() {
        if (!messageBox.value) return showStatus('Nothing to save!', 'var(--error-color)');
        const blob = new Blob([messageBox.value], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        const name = fileName.value.trim() || 'Untitled';
        a.href = url;
        a.download = name + '.enc';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        showStatus('üì• File saved!', 'var(--success-color)');
    }

    document.getElementById('fileUpload').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = ev => {
            messageBox.value = ev.target.result;
            fileName.value = file.name.replace('.enc', '').replace('.txt', '') || 'Untitled Document';
            updateStats(); showStatus('üìÇ File uploaded successfully', 'var(--success-color)');
        };
        reader.readAsText(file);
        this.value = null;
    });

    async function getCryptoKey(password, salt) {
        const keyMaterial = await window.crypto.subtle.importKey("raw", new TextEncoder().encode(password), "PBKDF2", false, ["deriveKey"]);
        return window.crypto.subtle.deriveKey({ name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" }, keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]);
    }

    function bufferToBase64(buffer) { return btoa(String.fromCharCode.apply(null, new Uint8Array(buffer))); }
    function base64ToBuffer(base64) {
        const binary = atob(base64); const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) bytes[i] = binary.charCodeAt(i);
        return bytes.buffer;
    }

    async function compressData(dataString) {
        const stream = new Blob([dataString]).stream().pipeThrough(new CompressionStream("gzip"));
        return await (new Response(stream)).arrayBuffer();
    }
    async function decompressData(buffer) {
        const stream = new Blob([buffer]).stream().pipeThrough(new DecompressionStream("gzip"));
        return await (new Response(stream)).arrayBuffer();
    }

    async function encryptMessage() {
        if (!secretKeyInput.value || !messageBox.value) return showStatus('Password and message are required', 'var(--error-color)');
        try {
            const expHours = parseInt(expirationSelect.value);
            const expTime = expHours === 0 ? 0 : Date.now() + (expHours * 60 * 60 * 1000);
            const payload = JSON.stringify({ e: expTime, m: messageBox.value });
            let payloadBytes = new TextEncoder().encode(payload);
            let isCompressed = 0;

            if (payloadBytes.length > 100) {
                payloadBytes = new Uint8Array(await compressData(payload)); isCompressed = 1;
            }

            const finalPayload = new Uint8Array(payloadBytes.length + 1);
            finalPayload[0] = isCompressed; finalPayload.set(payloadBytes, 1);

            const salt = window.crypto.getRandomValues(new Uint8Array(16));
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const key = await getCryptoKey(secretKeyInput.value, salt);

            const encryptedBuf = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, finalPayload);
            const encryptedBytes = new Uint8Array(encryptedBuf);

            const combined = new Uint8Array(16 + 12 + encryptedBytes.length);
            combined.set(salt, 0); combined.set(iv, 16); combined.set(encryptedBytes, 28);

            messageBox.value = bufferToBase64(combined.buffer);
            localStorage.setItem('savedMessage', messageBox.value); updateStats();
            showStatus('‚úÖ Encrypted successfully!', 'var(--success-color)');
        } catch (e) { showStatus('Encryption failed', 'var(--error-color)'); }
    }

    async function decryptMessage() {
        if (!secretKeyInput.value || !messageBox.value) return showStatus('Password and message are required', 'var(--error-color)');
        try {
            if (messageBox.value.includes(':')) {
                const parts = messageBox.value.split(':');
                if (parts.length !== 3) throw new Error("Invalid format");
                const key = await getCryptoKey(secretKeyInput.value, base64ToBuffer(parts[0]));
                const decryptedBuffer = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: base64ToBuffer(parts[1]) }, key, base64ToBuffer(parts[2]));
                let decryptedText = "";
                try { decryptedText = new TextDecoder().decode(await decompressData(decryptedBuffer)); }
                catch(e) { decryptedText = new TextDecoder().decode(decryptedBuffer); }
                const payload = JSON.parse(decryptedText);
                if (payload.exp && payload.exp !== 0 && Date.now() > payload.exp) { messageBox.value = ''; return showStatus('‚è≥ Message has expired', 'var(--error-color)'); }
                messageBox.value = payload.msg || decryptedText;
            } else {
                const combined = new Uint8Array(base64ToBuffer(messageBox.value));
                if (combined.length < 28) throw new Error("Invalid format");
                const salt = combined.slice(0, 16); const iv = combined.slice(16, 28); const encryptedBytes = combined.slice(28);

                const key = await getCryptoKey(secretKeyInput.value, salt);
                const decryptedBuffer = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, encryptedBytes);
                const decryptedBytes = new Uint8Array(decryptedBuffer);

                const isCompressed = decryptedBytes[0] === 1; const payloadBytes = decryptedBytes.slice(1);
                let decryptedText = isCompressed ? new TextDecoder().decode(await decompressData(payloadBytes.buffer)) : new TextDecoder().decode(payloadBytes);

                const payload = JSON.parse(decryptedText);
                if (payload.e !== 0 && Date.now() > payload.e) { messageBox.value = ''; return showStatus('‚è≥ Message has expired', 'var(--error-color)'); }
                messageBox.value = payload.m;
            }
            localStorage.setItem('savedMessage', messageBox.value); updateStats();
            showStatus('‚úÖ Decrypted successfully!', 'var(--success-color)');
        } catch (e) { showStatus('Decryption failed! Wrong password?', 'var(--error-color)'); }
    }

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('sw.js').catch(e => console.error(e)); }); }
</script>
</body>
</html>
